<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Aggregation Framework &mdash; MongoDB Manual 2.4.1</title>

    <link rel="shortcut icon" href="http://media.mongodb.org/favicon.ico" />
    <meta name="robots" content="index" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="release" content=""/>
    <link rel="canonical" href="http://docs.mongodb.org/manual/applications/aggregation" />

    
    
    <link rel="stylesheet" href="../../_static/mongodb-docs.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  false,
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="http://docs.mongodb.org/osd.xml" title="MongoDB Help"/>
<link rel="author" title="About these documents" href="../../about/" />
<link rel="top" title="MongoDB Manual" href="../../" />
<link rel="up" title="Aggregation" href="../../aggregation/" />
<link rel="next" title="Aggregation Framework Examples" href="../../tutorial/aggregation-examples/" />
<link rel="prev" title="Aggregation" href="../../aggregation/" />
<script>
  (function() {
    var cx = '017213726194841070573:WMX6838984';
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
  })();
</script>
  </head>
  <body>
<div id="top-right">
        <div class="user-right">
                <ul id="header-menu-bar" class="ajs-menu-bar">
                <li class="normal"><a target="_blank" href="http://groups.google.com/group/mongodb-user">Forums</a></li>
                <li class="normal"><a target="_blank" href="http://blog.mongodb.org/">Blog</a></li>
                <li class="normal"><a href="http://www.mongodb.org/downloads">Download</a></li>
                <li class="normal"><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers</a></li>
                <li class="normal"><a href="http://www.10gen.com/events">Events</a></li>
                <li class="normal last"><a class="last" href="http://docs.mongodb.org/manual/meta/translation">Translations</a></li>
                </ul>
        </div>
</div>
<div id="header-db" class="spread">
        <div class="split">
                <div id="logo">
                        <div><a href="../../"><img class="logo" src="http://media.mongodb.org/logo-mongodb.png" alt="MongoDB Logo"/></a></div>
                </div>
        </div>

<div class="search-db"><gcse:searchbox></gcse:searchbox></div>
<div id="etp">
<ul>
<li><a href="https://github.com/mongodb/docs/blob/master/source/applications/aggregation.txt" target="_blank" title="Edit applications/aggregation.txt on github">Edit this Page</a></li>
<li><a href="http://github.com/mongodb/docs" target="_blank" title="Fork the documentation on GitHub and contribute.">GitHub</a></li>
<li><a id="jirafeedback" href="https://jira.mongodb.org/secure/CreateIssueDetails!init.jspa?pid=10380&issuetype=4&priority=4&summary=Comment+on%3a+%22applications/aggregation%2Etxt%22" target="_blank" title="Report a problem with applications/aggregation.txt on Jira">Report a problem</a></li>
</ul>
</div>
</div>  
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            <div id="cse-results"><gcse:searchresults linkTarget="_top"></gcse:searchresults></div>
            
  <div class="section" id="aggregation-framework">
<h1>Aggregation Framework<a class="headerlink" href="#aggregation-framework" title="Permalink to this headline">¶</a></h1>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The MongoDB aggregation framework provides a means to calculate
aggregated values without having to use <a class="reference internal" href="../../reference/glossary/#term-map-reduce"><em class="xref std std-term">map-reduce</em></a>. While
map-reduce is powerful, it is often more difficult than
necessary for many simple aggregation tasks, such as totaling or
averaging field values.</p>
<p>If you&#8217;re familiar with <a class="reference internal" href="../../reference/glossary/#term-sql"><em class="xref std std-term">SQL</em></a>, the aggregation framework
provides similar functionality to <tt class="docutils literal"><span class="pre">GROUP</span> <span class="pre">BY</span></tt> and related SQL
operators as well as simple forms of &#8220;self joins.&#8221; Additionally, the
aggregation framework provides projection capabilities to reshape the
returned data. Using the projections in the aggregation framework, you
can add computed fields, create new virtual sub-objects, and extract
sub-fields into the top-level of results.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p>A presentation from MongoSV 2011: <a class="reference external" href="http://www.10gen.com/presentations/mongosv-2011/mongodbs-new-aggregation-framework">MongoDB&#8217;s New
Aggregation Framework</a>.</p>
<p class="last">Additionally, consider <a class="reference internal" href="../../tutorial/aggregation-examples/"><em>Aggregation Framework Examples</em></a> and
<a class="reference internal" href="../../reference/aggregation/"><em>Aggregation Framework Reference</em></a> for more documentation.</p>
</div>
</div>
<div class="section" id="framework-components">
<h2>Framework Components<a class="headerlink" href="#framework-components" title="Permalink to this headline">¶</a></h2>
<p>This section provides an introduction to the two concepts that
underpin the aggregation framework: <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipelines</em></a> and
<a class="reference internal" href="../../reference/glossary/#term-expression"><em class="xref std std-term">expressions</em></a>.</p>
<div class="section" id="pipelines">
<span id="aggregation-pipelines"></span><h3>Pipelines<a class="headerlink" href="#pipelines" title="Permalink to this headline">¶</a></h3>
<p>Conceptually, documents from a collection pass through an
aggregation pipeline, which transforms these objects as they pass through.
For those familiar with UNIX-like shells (e.g. bash,) the concept is
analogous to the pipe (i.e. <tt class="docutils literal"><span class="pre">|</span></tt>) used to string text filters together.</p>
<p>In a shell environment the pipe redirects a stream of characters from
the output of one process to the input of the next. The MongoDB
aggregation pipeline streams MongoDB documents from one <a class="reference internal" href="../../reference/aggregation/#aggregation-pipeline-operator-reference"><em>pipeline
operator</em></a> to the next to process the
documents. Pipeline operators can be repeated in the pipe.</p>
<p>All pipeline operators process a stream of documents and the
pipeline behaves as if the operation scans a <a class="reference internal" href="../../reference/glossary/#term-collection"><em class="xref std std-term">collection</em></a> and
passes all matching documents into the &#8220;top&#8221; of the pipeline.
Each operator in the pipeline transforms each document as it passes
through the pipeline.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pipeline operators need not produce one output document for every
input document: operators may also generate new documents or filter
out documents.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The pipeline cannot operate on values of the following types:
<tt class="docutils literal"><span class="pre">Binary</span></tt>, <tt class="docutils literal"><span class="pre">Symbol</span></tt>, <tt class="docutils literal"><span class="pre">MinKey</span></tt>, <tt class="docutils literal"><span class="pre">MaxKey</span></tt>, <tt class="docutils literal"><span class="pre">DBRef</span></tt>,
<tt class="docutils literal"><span class="pre">Code</span></tt>, and <tt class="docutils literal"><span class="pre">CodeWScope</span></tt>.</p>
</div>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p>The &#8220;<a class="reference internal" href="../../reference/aggregation/"><em>Aggregation Framework Reference</em></a>&#8221; includes
documentation of the following pipeline operators:</p>
<ul class="last simple">
<li><a class="reference internal" href="../../reference/aggregation/project/#stage._S_project" title="stage.$project"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$project</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/unwind/#stage._S_unwind" title="stage.$unwind"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$unwind</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/geoNear/#stage._S_geoNear" title="stage.$geoNear"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$geoNear</span></tt></a></li>
</ul>
</div>
</div>
<div class="section" id="expressions">
<span id="aggregation-expressions"></span><h3>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../../reference/aggregation/#aggregation-expression-operators"><em>Expressions</em></a> produce output
documents based on calculations performed on input documents. The
aggregation framework defines expressions using a document format
using prefixes.</p>
<p>Expressions are stateless and are only evaluated when seen by the
aggregation process. All aggregation expressions can only operate on
the current document in the pipeline, and cannot integrate data from
other documents.</p>
<p>The <a class="reference internal" href="../../reference/glossary/#term-accumulator"><em class="xref std std-term">accumulator</em></a> expressions used in the <a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a>
operator maintain that state (e.g.  totals, maximums, minimums, and
related data) as documents progress through the <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipeline</em></a>.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../../reference/aggregation/#aggregation-expression-operators"><em>Aggregation expressions</em></a> for additional examples of the
expressions provided by the aggregation framework.</p>
</div>
</div>
</div>
<div class="section" id="use">
<h2>Use<a class="headerlink" href="#use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="invocation">
<h3>Invocation<a class="headerlink" href="#invocation" title="Permalink to this headline">¶</a></h3>
<p>Invoke an <a class="reference internal" href="../../reference/glossary/#term-aggregation"><em class="xref std std-term">aggregation</em></a> operation with the <a class="reference internal" href="../../reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a>
wrapper in the <a class="reference internal" href="../../reference/mongo/#bin.mongo" title="bin.mongo"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongo</span></tt></a> shell or the <a class="reference internal" href="../../reference/command/aggregate/#dbcmd.aggregate" title="dbcmd.aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a>
<a class="reference internal" href="../../reference/glossary/#term-database-command"><em class="xref std std-term">database command</em></a>. Always call <a class="reference internal" href="../../reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> on a
collection object that determines the input documents of the aggregation <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipeline</em></a>.
The arguments to the <a class="reference internal" href="../../reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> method specify a sequence of <a class="reference internal" href="../../reference/aggregation/#aggregation-pipeline-operator-reference"><em>pipeline
operators</em></a>, where each
operator may have a number of operands.</p>
<p>First, consider a <a class="reference internal" href="../../reference/glossary/#term-collection"><em class="xref std std-term">collection</em></a> of documents named <tt class="docutils literal"><span class="pre">articles</span></tt>
using the following format:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
 <span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;this is my title&quot;</span> <span class="p">,</span>
 <span class="nx">author</span> <span class="o">:</span> <span class="s2">&quot;bob&quot;</span> <span class="p">,</span>
 <span class="nx">posted</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span> <span class="p">()</span> <span class="p">,</span>
 <span class="nx">pageViews</span> <span class="o">:</span> <span class="mi">5</span> <span class="p">,</span>
 <span class="nx">tags</span> <span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;fun&quot;</span> <span class="p">,</span> <span class="s2">&quot;good&quot;</span> <span class="p">,</span> <span class="s2">&quot;fun&quot;</span> <span class="p">]</span> <span class="p">,</span>
 <span class="nx">comments</span> <span class="o">:</span> <span class="p">[</span>
             <span class="p">{</span> <span class="nx">author</span> <span class="o">:</span><span class="s2">&quot;joe&quot;</span> <span class="p">,</span> <span class="nx">text</span> <span class="o">:</span> <span class="s2">&quot;this is cool&quot;</span> <span class="p">}</span> <span class="p">,</span>
             <span class="p">{</span> <span class="nx">author</span> <span class="o">:</span><span class="s2">&quot;sam&quot;</span> <span class="p">,</span> <span class="nx">text</span> <span class="o">:</span> <span class="s2">&quot;this is bad&quot;</span> <span class="p">}</span>
 <span class="p">],</span>
 <span class="nx">other</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span> <span class="o">:</span> <span class="mi">5</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following example aggregation operation pivots data to
create a set of author names grouped by tags applied to an
article. Call the aggregation framework by issuing the following
command:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
  <span class="p">{</span> <span class="nx">$project</span> <span class="o">:</span> <span class="p">{</span>
     <span class="nx">author</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
     <span class="nx">tags</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">$unwind</span> <span class="o">:</span> <span class="s2">&quot;$tags&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span> <span class="p">{</span>
     <span class="nx">_id</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">tags</span> <span class="o">:</span> <span class="s2">&quot;$tags&quot;</span> <span class="p">},</span>
     <span class="nx">authors</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$addToSet</span> <span class="o">:</span> <span class="s2">&quot;$author&quot;</span> <span class="p">}</span>
  <span class="p">}</span> <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The aggregation pipeline begins with the <a class="reference internal" href="../../reference/glossary/#term-collection"><em class="xref std std-term">collection</em></a>
<tt class="docutils literal"><span class="pre">articles</span></tt> and selects the <tt class="docutils literal"><span class="pre">author</span></tt> and <tt class="docutils literal"><span class="pre">tags</span></tt> fields using the
<a class="reference internal" href="../../reference/aggregation/project/#stage._S_project" title="stage.$project"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$project</span></tt></a> aggregation operator. The
<tt class="xref mongodb mongodb-expression docutils literal"><span class="pre">$unwind</span></tt> operator produces one output document per
tag. Finally, the <tt class="xref mongodb mongodb-expression docutils literal"><span class="pre">$group</span></tt> operator pivots these fields.</p>
</div>
<div class="section" id="result">
<h3>Result<a class="headerlink" href="#result" title="Permalink to this headline">¶</a></h3>
<p>The aggregation operation in the previous section returns a
<a class="reference internal" href="../../reference/glossary/#term-document"><em class="xref std std-term">document</em></a> with two fields:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">result</span></tt> which holds an array of documents returned by the <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipeline</em></a></li>
<li><tt class="docutils literal"><span class="pre">ok</span></tt> which holds the value <tt class="docutils literal"><span class="pre">1</span></tt>, indicating success, or another value
if there was an error</li>
</ul>
<p>As a document, the result is subject to the <a class="reference internal" href="../../reference/limits/#limit-bson-document-size"><em>BSON
Document size</em></a> limit, which is currently 16 megabytes.</p>
</div>
</div>
<div class="section" id="optimizing-performance">
<span id="aggregation-optimize-performance"></span><h2>Optimizing Performance<a class="headerlink" href="#optimizing-performance" title="Permalink to this headline">¶</a></h2>
<p>Because you will always call <a class="reference internal" href="../../reference/command/aggregate/#dbcmd.aggregate" title="dbcmd.aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a> on a
<a class="reference internal" href="../../reference/glossary/#term-collection"><em class="xref std std-term">collection</em></a> object, which logically inserts the <em>entire</em> collection into
the aggregation pipeline, you may want to optimize the operation
by avoiding scanning the entire collection whenever possible.</p>
<div class="section" id="pipeline-operators-and-indexes">
<span id="aggregation-pipeline-operators-and-performance"></span><h3>Pipeline Operators and Indexes<a class="headerlink" href="#pipeline-operators-and-indexes" title="Permalink to this headline">¶</a></h3>
<p>Depending on the order in which they appear in the pipeline,
aggregation operators can take advantage of indexes.</p>
<p>The following pipeline operators take advantage of an index when they
occur at the beginning of the pipeline:</p>
<ul class="simple">
<li><a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a>.</li>
</ul>
<p>The above operators can also use an index when placed <strong>before</strong> the
following aggregation operators:</p>
<ul class="simple">
<li><a class="reference internal" href="../../reference/aggregation/project/#stage._S_project" title="stage.$project"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$project</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/unwind/#stage._S_unwind" title="stage.$unwind"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$unwind</span></tt></a></li>
<li><a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a>.</li>
</ul>
<p class="versionadded">
<span class="versionmodified">New in version 2.4.</span></p>
<p>The <a class="reference internal" href="../../reference/aggregation/geoNear/#stage._S_geoNear" title="stage.$geoNear"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$geoNear</span></tt></a> pipeline operator takes advantage of a
geospatial index. When using <a class="reference internal" href="../../reference/aggregation/geoNear/#stage._S_geoNear" title="stage.$geoNear"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$geoNear</span></tt></a>, the
<a class="reference internal" href="../../reference/aggregation/geoNear/#stage._S_geoNear" title="stage.$geoNear"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$geoNear</span></tt></a> pipeline operation must appear as the first
stage in an aggregation pipeline.</p>
</div>
<div class="section" id="early-filtering">
<h3>Early Filtering<a class="headerlink" href="#early-filtering" title="Permalink to this headline">¶</a></h3>
<p>If your aggregation operation requires only a subset of the data in a
collection, use the <a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a> operator to restrict which items go
in to the top of the pipeline, as in a query. When placed early in a
pipeline, these <a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a> operations use suitable indexes
to scan only the matching documents in a collection.</p>
<p>Placing a <a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a> pipeline stage followed by a
<a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> stage at the
start of the pipeline is logically equivalent to a single query
with a sort, and can use an index.</p>
<p>In future versions there may be an optimization phase in the
pipeline that reorders the operations to increase performance without
affecting the result. However, at this time place
<a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a> operators at the beginning of the pipeline when
possible.</p>
</div>
<div class="section" id="pipeline-sequence-optimization">
<h3>Pipeline Sequence Optimization<a class="headerlink" href="#pipeline-sequence-optimization" title="Permalink to this headline">¶</a></h3>
<p class="versionchanged">
<span class="versionmodified">Changed in version 2.4.</span></p>
<p><a class="reference internal" href="../../reference/glossary/#term-aggregation"><em class="xref std std-term">Aggregation</em></a> operations have an optimization phase which
attempts to re-arrange the pipeline for improved performance.</p>
<div class="section" id="sort-skip-limit-sequence-optimization">
<h4><tt class="docutils literal"><span class="pre">$sort</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> + <tt class="docutils literal"><span class="pre">$limit</span></tt> Sequence Optimization<a class="headerlink" href="#sort-skip-limit-sequence-optimization" title="Permalink to this headline">¶</a></h4>
<p>When you have sequence of <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> followed by a
<a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> followed by a <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a>, an
optimization occurs whereby the <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> moves in front
of the <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a>. For example, if the pipeline consists of
the following stages:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">age</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}</span>
</pre></div>
</div>
<p>During the optimization phase, the optimizer transforms the sequence to
the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">age</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">15</span> <span class="p">}</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">10</span> <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> value has increased to the sum of the
initial value and the <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> value.</p>
</div>
</div>
<div class="section" id="limit-skip-limit-skip-sequence-optimization">
<h4><tt class="docutils literal"><span class="pre">$limit</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> + <tt class="docutils literal"><span class="pre">$limit</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> Sequence Optimization<a class="headerlink" href="#limit-skip-limit-skip-sequence-optimization" title="Permalink to this headline">¶</a></h4>
<p>When you have continuous sequence of <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> pipeline
stage followed by a <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> pipeline stage, the
aggregation will attempt to re-arrange the pipeline stages to combine
the limits together and the skips together. For example, if the
pipeline consists of the following stages:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">100</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">10</span><span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
</pre></div>
</div>
<p>During the intermediate step, the optimizer reverses the position of
the <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> followed by a <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> to
<a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> followed by the <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">100</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">15</span><span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> value has increased to the sum of the
initial value and the <a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> value. Then, for the final
<a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> value, the optimizer selects the minimum between
the adjacent <a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> values. For the final
<a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> value, the optimizer adds the adjacent
<a class="reference internal" href="../../reference/aggregation/skip/#stage._S_skip" title="stage.$skip"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$skip</span></tt></a> values, to transform the sequence to the
following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">15</span> <span class="p">},</span>
<span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">7</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="memory-for-cumulative-operators">
<h3>Memory for Cumulative Operators<a class="headerlink" href="#memory-for-cumulative-operators" title="Permalink to this headline">¶</a></h3>
<p>Certain pipeline operators require access to the entire input set
before they can produce any output. For example, <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a>
must receive all of the input from the preceding <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipeline</em></a>
operator before it can produce its first output document. The current
implementation of <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> does not go to disk in these
cases: in order to sort the contents of the pipeline, the entire input
must fit in memory.</p>
<p class="versionchanged">
<span class="versionmodified">Changed in version 2.4: </span>When a <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> immediately precedes a
<a class="reference internal" href="../../reference/aggregation/limit/#stage._S_limit" title="stage.$limit"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$limit</span></tt></a> in the pipeline, the <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a>
operation only maintains the top n results as it progresses, where n
is the specified limit. Before 2.4, <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> would sort
all the results in memory, and then limit the results to n results.</p>
<p><a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a> has similar characteristics: Before any
<a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a> passes its output along the pipeline, it must
receive the entirety of its input. For the <a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a>
operator, this frequently does not require as much memory as
<a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a>, because it only needs to retain one record for
each unique key in the grouping specification.</p>
<p>The current implementation of the aggregation framework logs a warning
if a cumulative operator consumes 5% or more of the physical memory on
the host. Cumulative operators produce an error if they consume 10% or
more of the physical memory on the host.</p>
</div>
</div>
<div class="section" id="sharded-operation">
<h2>Sharded Operation<a class="headerlink" href="#sharded-operation" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="versionchanged">
<span class="versionmodified">Changed in version 2.1.</span></p>
<p class="last">Some aggregation operations using <a class="reference internal" href="../../reference/command/aggregate/#dbcmd.aggregate" title="dbcmd.aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a> will
cause <a class="reference internal" href="../../reference/mongos/#bin.mongos" title="bin.mongos"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongos</span></tt></a> instances to require more CPU resources
than in previous versions. This modified performance profile may
dictate alternate architectural decisions if you use the
<a class="reference internal" href="../../reference/glossary/#term-aggregation-framework"><em class="xref std std-term">aggregation framework</em></a> extensively in a sharded environment.</p>
</div>
<p>The aggregation framework is compatible with sharded collections.</p>
<p>When operating on a sharded collection, the aggregation pipeline
is split into two parts. The aggregation framework pushes
all of the operators up to the first
<a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a> or <a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operation to each shard.
<a class="footnote-reference" href="#match-sharding" id="id1">[1]</a> Then, a second pipeline on the <a class="reference internal" href="../../reference/mongos/#bin.mongos" title="bin.mongos"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongos</span></tt></a>
runs. This pipeline consists of the first <a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a> or
<a class="reference internal" href="../../reference/aggregation/sort/#stage._S_sort" title="stage.$sort"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$sort</span></tt></a> and any remaining pipeline operators, and runs
on the results received from the shards.</p>
<p>The <a class="reference internal" href="../../reference/aggregation/group/#stage._S_group" title="stage.$group"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator brings in any &#8220;sub-totals&#8221; from
the shards and combines them: in some cases these may be
structures. For example, the <tt class="xref mongodb mongodb-expression docutils literal"><span class="pre">$avg</span></tt> expression
maintains a total and count for each shard; <a class="reference internal" href="../../reference/mongos/#bin.mongos" title="bin.mongos"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongos</span></tt></a> combines
these values and then divides.</p>
<table class="docutils footnote" frame="void" id="match-sharding" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>If an early <a class="reference internal" href="../../reference/aggregation/match/#stage._S_match" title="stage.$match"><tt class="xref mongodb mongodb-pipeline docutils literal"><span class="pre">$match</span></tt></a> can exclude
shards through the use of the shard key in the predicate, then
these operators are only pushed to the relevant shards.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>Aggregation operations with the <a class="reference internal" href="../../reference/command/aggregate/#dbcmd.aggregate" title="dbcmd.aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a> command have
the following limitations:</p>
<ul class="simple">
<li>The pipeline cannot operate on values of the following types:
<tt class="docutils literal"><span class="pre">Binary</span></tt>, <tt class="docutils literal"><span class="pre">Symbol</span></tt>, <tt class="docutils literal"><span class="pre">MinKey</span></tt>, <tt class="docutils literal"><span class="pre">MaxKey</span></tt>, <tt class="docutils literal"><span class="pre">DBRef</span></tt>, <tt class="docutils literal"><span class="pre">Code</span></tt>,
<tt class="docutils literal"><span class="pre">CodeWScope</span></tt>.</li>
<li>Output from the <a class="reference internal" href="../../reference/glossary/#term-pipeline"><em class="xref std std-term">pipeline</em></a> can only contain 16 megabytes. If
your result set exceeds this limit, the <a class="reference internal" href="../../reference/command/aggregate/#dbcmd.aggregate" title="dbcmd.aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a>
command produces an error.</li>
<li>If any single aggregation operation consumes more than 10 percent of
system RAM the operation will produce an error.</li>
</ul>
</div>
</div>


<div id="btnv">
<ul id="btnvl">
<li id="btnvpr"><a href="../../aggregation/" title="Previous Section: Aggregation">&lt; &nbsp; Aggregation</a></li>
<li id="btnvup"><a href="../../aggregation/" title="Parent Section: Aggregation" >&#47;&#92;&nbsp; Aggregation</a></li>
<li id="btnvnx"><a href="../../tutorial/aggregation-examples/" title="Next Section: Aggregation Framework Examples">Aggregation Framework Examples &nbsp;&gt;</a></li>
</ul>
</div>
</div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><h3><a href="../../contents/">MongoDB Manual</a>

<small><a href="../../genindex/">(Index)</a></small>
</h3>


<h4 id="vnd">Version: <span id="vn">2.4</span></h4>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/">Installing MongoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crud/">Core MongoDB Operations (CRUD)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../aggregation/">Aggregation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">Aggregation Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#framework-components">Framework Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pipelines">Pipelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expressions">Expressions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#use">Use</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#invocation">Invocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#result">Result</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#optimizing-performance">Optimizing Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pipeline-operators-and-indexes">Pipeline Operators and Indexes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#early-filtering">Early Filtering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pipeline-sequence-optimization">Pipeline Sequence Optimization</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#sort-skip-limit-sequence-optimization"><tt class="docutils literal"><span class="pre">$sort</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> + <tt class="docutils literal"><span class="pre">$limit</span></tt> Sequence Optimization</a></li>
<li class="toctree-l5"><a class="reference internal" href="#limit-skip-limit-skip-sequence-optimization"><tt class="docutils literal"><span class="pre">$limit</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> + <tt class="docutils literal"><span class="pre">$limit</span></tt> + <tt class="docutils literal"><span class="pre">$skip</span></tt> Sequence Optimization</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#memory-for-cumulative-operators">Memory for Cumulative Operators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sharded-operation">Sharded Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/aggregation-examples/">Aggregation Framework Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/aggregation/">Aggregation Framework Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../map-reduce/">Map-Reduce</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/simple-aggregation/">Simple Aggregation Methods and Commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../text-search/">Text Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indexes/">Indexes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replication/">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sharding/">Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mongo/">Using the <tt class="docutils literal"><span class="pre">mongo</span></tt> Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../use-cases/">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/">MongoDB Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/">About MongoDB Documentation</a></li>
</ul>

<h3 style="padding-bottom: 1em;"><a href="http://www.mongodb.org/about/">MongoDB.org</a></h3>
<h3 style="padding-bottom: 1em;"><a href="http://docs.mongodb.org/ecosystem/">MongoDB Ecosystem</a></h3><h3>Formats</h3>
<ul class="this-page-menu">
  <li><a href="/manual/single/">MongoDB Manual, Single HTML Page</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.pdf" rel="nofollow">MongoDB Manual, PDF Format</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.epub" rel="nofollow">MongoDB Manual, ePub Format</a></li>
</ul><h3>MongoDB Resources</h3>

<ul>
 <li><strong>Getting Started</strong>
   <ul>
     <li><a href="http://www.mongodb.org/about/introduction">Introduction</a></li>
     <li><a href="http://www.mongodb.org/downloads">Downloads</a></li>
   </ul>
 </li>
 <li><strong><a href="http://www.mongodb.org/about/community">Community</a> and <a href="http://docs.mongodb.org/ecosystem/">Ecosystem</a></strong>
   <ul>
     <li><a href="http://www.10gen.com">10gen</a></li>
     <li><a href="http://www.10gen.com/events">MongoDB Events</a></li>
     <li><a href="http://planet.mongodb.org">Planet MongoDB</a></li>
     <li><a href="http://mongodb.org/about/community/masters">MongoDB Masters</a></li>
     <li><a href="http://www.10gen.com/presentations">Slides and Video</a></li>
     <li><a href="http://docs.mongodb.org/ecosystem/platforms/">Hosting Center</a></li>
     <li><a href="http://docs.mongodb.org/ecosystem/platforms/windows">Windows</a></li>
     <li><a href="http://www.10gen.com/products/mms/">MongoDB Monitoring Service</a> (<a href="http://mms.10gen.com/help/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/tools/administration-interfaces/">Administrative Interfaces</a></li>
     <li><a href="http://www.10gen.com/books/">MongoDB Books</a></li>
   </ul>
 </li>
 <li><strong><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers</a></strong>
   <ul>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/javascript">JavaScript</a> (<a href="http://api.mongodb.org/js/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/python">Python</a> (<a href="http://api.mongodb.org/python/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/ruby">Ruby</a> (<a href="http://api.mongodb.org/ruby/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/php">PHP</a> (<a href="http://php.net/mongo/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/perl">Perl</a> (<a href="http://api.mongodb.org/perl/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/java">Java</a> (<a href="http://api.mongodb.org/java/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/scala">Scala</a> (<a href="http://api.mongodb.org/scala/casbah/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/csharp">C#</a> (<a href="http://api.mongodb.org/csharp/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/c">C</a> (<a href="http://api.mongodb.org/c/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/cpp">C++</a> (<a href="http://api.mongodb.org/cplusplus/current/">docs</a>)</li>
     <li><a href="http://hackage.haskell.org/package/mongoDB">Haskell</a> (<a href="http://api.mongodb.org/haskell">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/erlang">Erlang</a> (<a href="http://api.mongodb.org/erlang">docs</a>)</li>
   </ul>
 </li>
</ul>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    <p>
       &copy; <a href="">Copyright</a> 2011-2013, 10gen, Inc. 
       MongoDB&reg;, Mongo&reg;, and the leaf logo are registered trademarks of 10gen, Inc.
    </p>
  </div><script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_require', 'inpage_linkid', pluginUrl]);
_gaq.push(['_setAccount', 'UA-7301842-8']);
_gaq.push(['_setDomainName', 'docs.mongodb.org']);
_gaq.push(['_trackPageview']);
(function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
        })();
</script>

<script type="text/javascript">
document.write(unescape("%3Cscript src='" + document.location.protocol + "//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script>try { mktoMunchkin("017-HGS-593"); } catch(e) {}</script><script type="text/javascript">
jQuery.ajax({
	 url: "https://jira.mongodb.org/s/en_UScn8g8x/782/6/1.2.5/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?collectorId=298ba4e7",
	 type: "get",
	 cache: true,
	 dataType: "script"
	});
window.ATL_JQ_PAGE_PROPS =  {
	"triggerFunction": function(showCollectorDialog) {
		jQuery("#jirafeedback").click(function(e) {e.preventDefault();showCollectorDialog();});},
		fieldValues: {component: 'mongodb-manual', summary: 'Comment on: "manual/applications/aggregation.txt"'},
		environment: {'repo': 'docs','source': 'applications/aggregation'}
		};
</script><script type="text/javascript">
var versions = [{'t': '2.4 (current)', 'v': 'v2.4'}, {'t': '2.2', 'v': 'v2.2'}]
var pagename = 'applications/aggregation'
var stable = 'v2.4'

function vfnav() {
    if ( pagename=='index' ) {
        pn = ''
    }
    else {
        pn = pagename
    }

    v = $(this).children("option:selected").attr('value')

    if ( (v==0) || (v==stable) ) {
        uri = '/manual/' + pn
    }
    else {
        uri = '/' + v + '/' + pn
    }
    window.location.href= uri;
}

$(document).ready(function(){
    $("#vn").html(function(){
        s=$("<select/>");
        o='<option/>';

        $.each(versions,function(index, version) {
            if ( version.v==stable ) {
                dv=true;
            }
            $(o,{value:version.v,text: version.t}).appendTo(s);
        });

        if ( dv==false ) {
            $(o, {value:0,text:'(stable)'}).appendTo(s);
        }
        return(s);
    });

    $("#vn select").bind('change', vfnav);
    $('#vn select').val('v2.4');
});
</script>
</body>
</html>